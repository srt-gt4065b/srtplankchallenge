<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin - Final</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
    /* UI/UX ìŠ¤íƒ€ì¼ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
    .container { max-width: 900px; margin: 0 auto; }
    
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .login-card { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; }
    
    .header { text-align: center; color: white; margin-bottom: 20px; }
    .tab-nav { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 12px; }
    .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: white; font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s; }
    .tab-btn.active { background: white; color: #667eea; }
    
    .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    
    .attendance-table-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; }
    .attendance-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
    .attendance-table th, .attendance-table td { padding: 8px 4px; border: 1px solid #eee; text-align: center; }
    .attendance-table th { background: #f8f9fa; }
    
    .sun-col { color: #e53935; background: #fff5f5 !important; font-weight: bold; }
    .future-col { background: #fafafa; color: #ccc; }
    .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; }
    
    .ranking-item { display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 10px; margin-bottom: 8px; border-left: 5px solid #667eea; }
    .month-selector { display: flex; align-items: center; gap: 15px; justify-content: center; margin-bottom: 20px; background: white; padding: 10px; border-radius: 50px; }
</style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h2>Admin ì¸ì¦</h2>
        <div class="form-group" style="margin-top:20px;">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" onkeypress="if(event.keyCode==13) checkLogin()">
        </div>
        <button class="btn-primary" onclick="checkLogin()">ì ‘ì†í•˜ê¸°</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container" id="admin-main" style="display: none;">
    <div class="header">
        <h1>âš™ï¸ SRT Challenge í†µí•© ê´€ë¦¬ì</h1>
        <p id="currentViewLabel">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div class="month-selector">
        <button onclick="changeMonth(-1)" style="border:none; background:none; cursor:pointer; font-size:20px;">â—€</button>
        <span id="targetMonthDisplay" style="font-weight:700; font-size:18px;">2025ë…„ 12ì›”</span>
        <button onclick="changeMonth(1)" style="border:none; background:none; cursor:pointer; font-size:20px;">â–¶</button>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="changeTab('dashboard')">ğŸ“Š ìˆœìœ„</button>
        <button class="tab-btn" onclick="changeTab('attendance')">ğŸ“… ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="changeTab('edit')">âœï¸ ìˆ˜ì •</button>
        <button class="tab-btn" onclick="changeTab('report')">ğŸ’° ì •ì‚°</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <div class="card">
            <div class="card-title">ğŸ† ì„ íƒ ì›” ëˆ„ì  ì„±ê³µ ìˆœìœ„</div>
            <div id="rankList"></div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content">
        <div class="card">
            <div class="attendance-table-wrapper">
                <table class="attendance-table">
                    <thead id="atHead"></thead>
                    <tbody id="atBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="card">
            <div class="card-title">âœï¸ íŠ¹ì • ë‚ ì§œ ì¸ì¦ ê°•ì œ ìˆ˜ì •</div>
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="inputDate"></div>
            <div class="form-group"><label>íšŒì›</label><select id="inputUser"></select></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:#43a047;" onclick="doManual(true)">ì¶œì„ ì²˜ë¦¬</button>
                <button class="btn-primary" style="background:#e53935;" onclick="doManual(false)">ê¸°ë¡ ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ’¸ ë§ˆê° ì •ì‚° ë¦¬í¬íŠ¸</div>
            <div class="form-group"><label>ì¸ì¦ ì‹œì‘ì¼ (ì´ ë‚ ì§œë¶€í„° ê³„ì‚°)</label><input type="date" id="startDateInput"></div>
            <div class="form-group"><label>ë¯¸ì¸ì¦ ë²Œê¸ˆ (ì›)</label><input type="number" id="feeInput" value="5000"></div>
            <button class="btn-primary" onclick="makeReport()">ì„ íƒ ì›” ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="reportBox" class="card" style="display:none;">
            <div id="reportText" style="white-space:pre-wrap; line-height:1.6;"></div>
            <button class="btn-primary" style="background:#333; margin-top:15px;" onclick="copyReport()">ë‚´ìš© ë³µì‚¬í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
let participants = {};
let allCheckins = {};
let firebaseDb;

// ì¡°íšŒ ê¸°ì¤€ ë‚ ì§œ (ê¸°ë³¸ê°’: ì˜¤ëŠ˜)
let viewDate = new Date();
const todayDate = new Date();
todayDate.setHours(0,0,0,0);

function checkLogin() {
    if(document.getElementById('adminPw').value === "1230") {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('admin-main').style.display = 'block';
        init();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function init() {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    firebaseDb = firebase.database();
    
    // ë°ì´í„° ì‹¤ì‹œê°„ ê°ì‹œ
    firebaseDb.ref("participants").on("value", snap => {
        participants = snap.val() || {};
        updateDropdown();
        refresh();
    });
    firebaseDb.ref("checkins").on("value", snap => {
        allCheckins = snap.val() || {};
        refresh();
    });
}

function changeMonth(val) {
    viewDate.setMonth(viewDate.getMonth() + val);
    refresh();
}

function refresh() {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth() + 1;
    document.getElementById('targetMonthDisplay').innerText = `${year}ë…„ ${month}ì›”`;
    document.getElementById('currentViewLabel').innerText = `${year}ë…„ ${month}ì›” ê´€ë¦¬ ëª¨ë“œ`;
    
    // 1ì¼ë¡œ ì‹œì‘ì¼ ê¸°ë³¸ ì„¸íŒ…
    document.getElementById('startDateInput').value = `${year}-${String(month).padStart(2,'0')}-01`;
    
    renderRanking(year, month);
    renderAttendance(year, month);
}

function renderRanking(year, month) {
    const lastDay = new Date(year, month, 0).getDate();
    let scores = [];

    Object.entries(participants).forEach(([uid, p]) => {
        let count = 0;
        for(let i=1; i<=lastDay; i++) {
            const dKey = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(allCheckins[dKey] && allCheckins[dKey][uid]) count++;
        }
        scores.push({ name: p.name, count, uid });
    });

    scores.sort((a,b) => b.count - a.count);
    document.getElementById('rankList').innerHTML = scores.map((s, i) => `
        <div class="ranking-item">
            <span><b>${i+1}ìœ„</b> ${s.name} (${s.uid})</span>
            <b>${s.count}íšŒ ì„±ê³µ</b>
        </div>
    `).join('');
}

function renderAttendance(year, month) {
    const lastDay = new Date(year, month, 0).getDate();
    let head = '<tr><th>ì´ë¦„</th>';
    for(let i=1; i<=lastDay; i++) {
        const d = new Date(year, month-1, i);
        const isSun = d.getDay() === 0;
        const isFuture = d > todayDate;
        head += `<th class="${isSun?'sun-col':''} ${isFuture?'future-col':''}">${i}</th>`;
    }
    head += '</tr>';
    document.getElementById('atHead').innerHTML = head;

    let body = '';
    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        body += `<tr><td>${p.name}</td>`;
        for(let i=1; i<=lastDay; i++) {
            const d = new Date(year, month-1, i);
            const dKey = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const ok = allCheckins[dKey] && allCheckins[dKey][uid];
            
            if(d.getDay() === 0) body += `<td class="sun-col">ì¼</td>`;
            else if(d > todayDate) body += `<td class="future-col">-</td>`;
            else body += `<td>${p.status==='rest'?'íœ´':(ok?'O':'X')}</td>`;
        }
        body += '</tr>';
    });
    document.getElementById('atBody').innerHTML = body;
}

function makeReport() {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth() + 1;
    const fee = document.getElementById('feeInput').value;
    const startDate = new Date(document.getElementById('startDateInput').value);
    startDate.setHours(0,0,0,0);
    const lastDay = new Date(year, month, 0).getDate();
    
    let totalPenalty = 0;
    let text = `[${year}ë…„ ${month}ì›” ì±Œë¦°ì§€ ì •ì‚° ê²°ê³¼]\n`;
    text += `ê¸°ì¤€ì¼: ${document.getElementById('startDateInput').value} ~ ì˜¤ëŠ˜\n`;
    text += `------------------------------\n`;

    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        if(p.status === 'rest') return;
        let absent = 0;
        for(let i=1; i<=lastDay; i++) {
            const d = new Date(year, month-1, i);
            d.setHours(0,0,0,0);
            if(d < startDate || d.getDay() === 0 || d > todayDate) continue;
            
            const dKey = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(!(allCheckins[dKey] && allCheckins[dKey][uid])) absent++;
        }
        const money = absent * fee;
        totalPenalty += money;
        if(money > 0) text += `${p.name}: ë¯¸ì¸ì¦ ${absent}íšŒ â†’ ${money.toLocaleString()}ì›\n`;
    });

    text += `------------------------------\n`;
    text += `ì´ ì§•ìˆ˜ ê¸ˆì•¡: ${totalPenalty.toLocaleString()}ì›`;
    
    document.getElementById('reportText').innerText = text;
    document.getElementById('reportBox').style.display = 'block';
}

// íƒ­ ì „í™˜ ë° ê¸°íƒ€ ìœ í‹¸
function changeTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}
function updateDropdown() {
    const sel = document.getElementById('inputUser');
    sel.innerHTML = '<option value="">íšŒì› ì„ íƒ</option>';
    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        sel.innerHTML += `<option value="${uid}">${uid}. ${p.name}</option>`;
    });
}
async function doManual(isPresent) {
    const date = document.getElementById('inputDate').value;
    const uid = document.getElementById('inputUser').value;
    if(!date || !uid) return alert("ë‚ ì§œì™€ íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");
    const path = `checkins/${date}/${uid}`;
    isPresent ? await firebaseDb.ref(path).set({ name: participants[uid].name, timestamp: Date.now() }) : await firebaseDb.ref(path).remove();
    alert("ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
}
function copyReport() {
    const t = document.getElementById('reportText').innerText;
    navigator.clipboard.writeText(t).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
}
</script>
</body>
</html>
