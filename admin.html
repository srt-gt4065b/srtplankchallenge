<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin - í†µí•© ê´€ë¦¬ì</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
.header { text-align: center; color: white; margin-bottom: 25px; }
.tab-nav { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 12px; }
.tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: white; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; }
.tab-btn.active { background: white; color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
.card-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
.dashboard-card { background: white; border-radius: 16px; padding: 20px; text-align: center; }
.dashboard-number { font-size: 36px; font-weight: 700; color: #667eea; }
.dashboard-label { font-size: 13px; color: #888; }
.month-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; justify-content: center; color: white; }
.month-btn { padding: 8px 15px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px; cursor: pointer; }
.attendance-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
.attendance-table th, .attendance-table td { padding: 8px 4px; text-align: center; border: 1px solid #e0e0e0; }
.attendance-table th { background: #f5f5f5; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
.form-group select, .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; }
.btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
.alert { padding: 12px; border-radius: 10px; margin-top: 15px; font-size: 14px; display: none; text-align: center; }
.alert.success { background: #e8f5e9; color: #2e7d32; display: block; }
.ranking-item { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 5px; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš™ï¸ SRT Challenge í†µí•© ê´€ë¦¬ì</h1>
        <p>ì¶œì„ ìˆ˜ì • ë° ì›”ë§ˆê° ë¦¬í¬íŠ¸</p>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" onclick="showTab('attendance')">ğŸ“… ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="showTab('edit')">âœï¸ ì¶œì„ìˆ˜ì •</button>
        <button class="tab-btn" onclick="showTab('report')">ğŸ’° ì •ì‚°ê´€ë¦¬</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="dashboard-number" id="dashTotalMembers">0</div>
                <div class="dashboard-label">ì „ì²´ íšŒì›</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number success" id="dashTodayPresent">0</div>
                <div class="dashboard-label">ì˜¤ëŠ˜ ì¶œì„</div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ† ì´ë²ˆ ë‹¬ ì¶œì„ TOP 5</div>
            <div id="rankingList"></div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content">
        <div class="month-selector">
            <button class="month-btn" onclick="changeMonth(-1)">â—€</button>
            <div id="monthDisplay" style="font-weight:bold; font-size:18px;"></div>
            <button class="month-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="card" style="overflow-x: auto;">
            <table class="attendance-table">
                <thead id="attendanceHead"></thead>
                <tbody id="attendanceBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="card">
            <div class="card-title">âœï¸ ì¶œì„ ë°ì´í„° ìˆ˜ë™ ìˆ˜ì •</div>
            <div class="form-group">
                <label>ë‚ ì§œ ì„ íƒ</label>
                <input type="date" id="manualDate">
            </div>
            <div class="form-group">
                <label>íšŒì› ì„ íƒ</label>
                <select id="manualUser"></select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:#43a047;" onclick="processManual(true)">ì¸ì¦ ì²˜ë¦¬ (O)</button>
                <button class="btn-primary" style="background:#e53935;" onclick="processManual(false)">ì¸ì¦ ì·¨ì†Œ (X)</button>
            </div>
            <div id="manualMsg" class="alert"></div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ‘¤ íšŒì› ìƒíƒœ ê´€ë¦¬ (ì •ìƒ/íœ´ì‹)</div>
            <div class="form-group">
                <label>íšŒì› ì„ íƒ</label>
                <select id="statusUserSelect"></select>
            </div>
            <div class="form-group">
                <label>ìƒíƒœ ì„¤ì •</label>
                <select id="statusValueSelect">
                    <option value="normal">ì •ìƒ í™œë™</option>
                    <option value="rest">íœ´ì‹ ì¤‘</option>
                </select>
            </div>
            <button class="btn-primary" onclick="updateMemberStatus()">ìƒíƒœ ë³€ê²½ ì €ì¥</button>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ’¸ ì›”ë§ˆê° ì§•ìˆ˜ê¸ˆ ë¦¬í¬íŠ¸ ìƒì„±</div>
            <div class="form-group">
                <label>ë¯¸ì¶œì„ 1íšŒë‹¹ ë²Œê¸ˆ (ì›)</label>
                <input type="number" id="penaltyPrice" value="5000">
            </div>
            <button class="btn-primary" onclick="generateMonthlyReport()">ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°</button>
        </div>
        <div id="reportArea" class="card" style="display:none;">
            <div id="reportContent"></div>
            <button class="btn-primary" style="background:#333;" onclick="copyToClipboard()">ğŸ“‹ ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
        </div>
    </div>
</div>

<script>
let participants = {};
let allCheckins = {};
let db;
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// Firebase ì´ˆê¸°í™” (config.jsê°€ ì—†ì„ ê²½ìš° ì§ì ‘ ì…ë ¥)
if (typeof firebaseConfig === 'undefined') {
    var firebaseConfig = {
        // ì—¬ê¸°ì— ìì‹ ì˜ firebase ì„¤ì •ì„ ë„£ìœ¼ì„¸ìš”
    };
}

function init() {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    
    // ë°ì´í„° ë¡œë“œ
    db.ref("participants").on("value", snap => {
        participants = snap.val() || {};
        updateSelects();
        render();
    });
    
    db.ref("checkins").on("value", snap => {
        allCheckins = snap.val() || {};
        render();
    });
}

function showTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

function updateSelects() {
    const selects = ['manualUser', 'statusUserSelect'];
    selects.forEach(sId => {
        const el = document.getElementById(sId);
        if(!el) return;
        el.innerHTML = '<option value="">-- íšŒì› ì„ íƒ --</option>';
        Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([id, p]) => {
            el.innerHTML += `<option value="${id}">${id}. ${p.name}</option>`;
        });
    });
}

function render() {
    // ëŒ€ì‹œë³´ë“œ
    document.getElementById('dashTotalMembers').innerText = Object.keys(participants).length;
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dashTodayPresent').innerText = Object.keys(allCheckins[today] || {}).length;
    
    // ë­í‚¹
    const rankList = document.getElementById('rankingList');
    rankList.innerHTML = '';
    const counts = {};
    Object.keys(allCheckins).forEach(date => {
        if(date.startsWith(`${currentYear}-${String(currentMonth).padStart(2,'0')}`)) {
            Object.keys(allCheckins[date]).forEach(id => {
                counts[id] = (counts[id] || 0) + 1;
            });
        }
    });
    Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([id, count]) => {
        rankList.innerHTML += `<div class="ranking-item"><span>${participants[id]?.name}</span><b>${count}íšŒ</b></div>`;
    });

    // ì¶œì„ë¶€ í…Œì´ë¸”
    document.getElementById('monthDisplay').innerText = `${currentYear}ë…„ ${currentMonth}ì›”`;
    const days = new Date(currentYear, currentMonth, 0).getDate();
    let head = '<tr><th>ì´ë¦„</th>';
    for(let i=1; i<=days; i++) head += `<th>${i}</th>`;
    head += '</tr>';
    document.getElementById('attendanceHead').innerHTML = head;

    let body = '';
    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([id, p]) => {
        body += `<tr><td>${p.name}</td>`;
        for(let i=1; i<=days; i++) {
            const dKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const ok = allCheckins[dKey] && allCheckins[dKey][id];
            body += `<td>${p.status==='rest'?'íœ´':(ok?'O':'X')}</td>`;
        }
        body += '</tr>';
    });
    document.getElementById('attendanceBody').innerHTML = body;
}

// ìˆ˜ë™ ìˆ˜ì •
async function processManual(isPresent) {
    const date = document.getElementById('manualDate').value;
    const id = document.getElementById('manualUser').value;
    if(!date || !id) return alert("ë‚ ì§œì™€ íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");

    if(isPresent) {
        await db.ref(`checkins/${date}/${id}`).set({ name: participants[id].name, timestamp: Date.now() });
    } else {
        await db.ref(`checkins/${date}/${id}`).remove();
    }
    const msg = document.getElementById('manualMsg');
    msg.innerText = "ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
    msg.classList.add('success');
    setTimeout(()=>msg.style.display='none', 2000);
}

// ìƒíƒœ ë³€ê²½
async function updateMemberStatus() {
    const id = document.getElementById('statusUserSelect').value;
    const val = document.getElementById('statusValueSelect').value;
    if(!id) return alert("íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");
    await db.ref(`participants/${id}/status`).set(val);
    alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// ë¦¬í¬íŠ¸ ìƒì„±
function generateMonthlyReport() {
    const price = document.getElementById('penaltyPrice').value;
    const days = new Date(currentYear, currentMonth, 0).getDate();
    let total = 0;
    let html = `<h3 style="margin-bottom:15px; text-align:center;">${currentMonth}ì›” ì •ì‚° ë¦¬í¬íŠ¸</h3>`;
    let textBody = '';

    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([id, p]) => {
        if(p.status === 'rest') return;
        let absent = 0;
        for(let i=1; i<=days; i++) {
            const dKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(!(allCheckins[dKey] && allCheckins[dKey][id])) absent++;
        }
        const penalty = absent * price;
        total += penalty;
        html += `<div class="ranking-item"><span>${p.name} (ê²°ì„ ${absent}íšŒ)</span><b>${penalty.toLocaleString()}ì›</b></div>`;
    });
    
    html += `<div style="margin-top:15px; text-align:right; font-weight:bold; color:#e53935;">ì´ ì§•ìˆ˜ì•¡: ${total.toLocaleString()}ì›</div>`;
    document.getElementById('reportContent').innerHTML = html;
    document.getElementById('reportArea').style.display = 'block';
}

function copyToClipboard() {
    const content = document.getElementById('reportContent').innerText;
    navigator.clipboard.writeText(content).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
}

function changeMonth(n) {
    currentMonth += n;
    if(currentMonth > 12) { currentMonth=1; currentYear++; }
    if(currentMonth < 1) { currentMonth=12; currentYear--; }
    render();
}

window.onload = init;
</script>
</body>
</html>
