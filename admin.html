<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin - Final Enterprise</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
    /* ê¸°ë³¸ ë””ìì¸ ì‹œìŠ¤í…œ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; }
    
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .login-card { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }
    
    .header { text-align: center; color: white; margin-bottom: 20px; }
    .month-selector { display: flex; align-items: center; gap: 15px; justify-content: center; margin-bottom: 20px; background: white; padding: 10px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    .tab-nav { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 12px; flex-wrap: wrap; }
    .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: white; font-weight: 600; cursor: pointer; border-radius: 8px; min-width: 80px; }
    .tab-btn.active { background: white; color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    
    /* ì—‘ì…€ ìŠ¤íƒ€ì¼ ì¶œì„ë¶€ */
    .at-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: 10px; }
    .at-table { width: 100%; border-collapse: collapse; font-size: 11px; text-align: center; background: white; }
    .at-table th, .at-table td { padding: 8px 4px; border: 1px solid #eee; }
    .at-table th { background: #f8f9fa; font-weight: bold; }
    .sun-col { background: #fff5f5 !important; color: #e53935; font-weight: bold; }
    .future-col { background: #fafafa; color: #ccc; }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn-excel { background: #217346; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    .btn-excel:hover { background: #1a5c38; }

    /* ê·¸ë£¹í™” ìŠ¤íƒ€ì¼ */
    .group-container { margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; }
    .group-header { background: #f1f3f9; padding: 10px 15px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; }
    .group-body { padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; background: white; }
    .member-tag { padding: 5px 10px; background: #f0f2f5; border-radius: 6px; font-size: 13px; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }

    /* íšŒì›ê´€ë¦¬ ì „ìš© ìŠ¤íƒ€ì¼ */
    .manage-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    .manage-row:last-child { border-bottom: none; }
    .manage-info { display: flex; align-items: center; gap: 10px; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .status-active { background: #e8f5e9; color: #2e7d32; } /* ì°¸ì—¬ì¤‘/ìˆ™ë©´ */
    .status-rest { background: #f5f5f5; color: #757575; }   /* íœ´ë©´ */
    .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; margin-left: 5px;}
    .btn-danger { background: #ffebee; color: #c62828; }
    .input-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .input-row input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
</style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h2>Admin Login</h2>
        <div class="form-group" style="margin-top:20px;"><input type="password" id="adminPw" placeholder="Password" onkeypress="if(event.keyCode==13) checkLogin()"></div>
        <button class="btn-primary" onclick="checkLogin()">ì ‘ì†</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜</p>
    </div>
</div>

<div class="container" id="admin-main" style="display: none;">
    <div class="header"><h1>âš™ï¸ SRT Challenge ê´€ë¦¬ ì‹œìŠ¤í…œ</h1></div>

    <div class="month-selector">
        <button onclick="changeMonth(-1)" style="border:none; background:none; cursor:pointer; font-size:20px;">â—€</button>
        <span id="monthDisplay" style="font-weight:700; font-size:18px;"></span>
        <button onclick="changeMonth(1)" style="border:none; background:none; cursor:pointer; font-size:20px;">â–¶</button>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="changeTab('rank')">ğŸ† ì„±ê³µê·¸ë£¹</button>
        <button class="tab-btn" onclick="changeTab('attendance')">ğŸ“… ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="changeTab('report')">ğŸ’° ë²Œê¸ˆì •ì‚°</button>
        <button class="tab-btn" onclick="changeTab('manage')" style="background: rgba(0,0,0,0.2);">âš™ï¸ íšŒì›ê´€ë¦¬</button>
    </div>

    <div id="tab-rank" class="tab-content active">
        <div class="card">
            <div class="card-title">ğŸ‘¥ ì´ë²ˆ ë‹¬ ì„±ê³µ íšŸìˆ˜ë³„ ê·¸ë£¹</div>
            <div id="groupList">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content">
        <div class="card">
            <div class="card-title">
                ğŸ“… ìƒì„¸ ì¶œì„ í˜„í™©
                <button class="btn-excel" onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="at-wrapper">
                <table class="at-table" id="attendanceTable">
                    <thead id="atHead"></thead>
                    <tbody id="atBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ’° ë²Œê¸ˆ ë¦¬í¬íŠ¸</div>
            <div class="form-group"><label>ì¸ì¦ ì‹œì‘ì¼</label><input type="date" id="startDateInput"></div>
            <div class="form-group"><label>ê²°ì„ 1íšŒë‹¹ ë²Œê¸ˆ</label><input type="number" id="feeInput" value="5000"></div>
            <button class="btn-primary" onclick="makeReport()">ê²°ê³¼ ìƒì„±</button>
        </div>
        <div id="reportBox" class="card" style="display:none;">
            <div id="reportText" style="white-space:pre-wrap; font-size:14px;"></div>
            <button class="btn-primary" style="background:#333; margin-top:15px;" onclick="copyReport()">ë³µì‚¬í•˜ê¸°</button>
        </div>
    </div>

    <div id="tab-manage" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ‘¤ ì‹ ê·œ íšŒì› ë“±ë¡</div>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">IDëŠ” ìˆ«ìë¡œ ì…ë ¥í•˜ë©´ ì •ë ¬í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤ (ì˜ˆ: 1, 99)</p>
            <div class="input-row">
                <input type="number" id="newUserId" placeholder="ID (ë²ˆí˜¸)">
                <input type="text" id="newUserName" placeholder="ì´ë¦„">
            </div>
            <button class="btn-primary" onclick="registerUser()">ë“±ë¡í•˜ê¸°</button>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“‹ ì „ì²´ íšŒì› ê´€ë¦¬ (ìƒíƒœ ë³€ê²½)</div>
            <div id="manageList">
                </div>
        </div>
    </div>

</div>

<script>
let participants = {};
let allCheckins = {};
let firebaseDb;
let viewDate = new Date();
const today = new Date();
today.setHours(0,0,0,0);

function checkLogin() {
    if(document.getElementById('adminPw').value === "1230") {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('admin-main').style.display = 'block';
        init();
    } else { document.getElementById('loginError').style.display = 'block'; }
}

function init() {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    firebaseDb = firebase.database();
    firebaseDb.ref("participants").on("value", s => { participants = s.val() || {}; refresh(); });
    firebaseDb.ref("checkins").on("value", s => { allCheckins = s.val() || {}; refresh(); });
}

function changeMonth(v) { viewDate.setMonth(viewDate.getMonth() + v); refresh(); }

function refresh() {
    const y = viewDate.getFullYear();
    const m = viewDate.getMonth() + 1;
    document.getElementById('monthDisplay').innerText = `${y}ë…„ ${m}ì›”`;
    document.getElementById('startDateInput').value = `${y}-${String(m).padStart(2,'0')}-01`;
    renderGroupRank(y, m);
    renderAttendance(y, m);
    renderManageList(); // íšŒì› ê´€ë¦¬ ëª©ë¡ ê°±ì‹ 
}

function renderGroupRank(year, month) {
    const lastDay = new Date(year, month, 0).getDate();
    let grouped = {};
    Object.entries(participants).forEach(([uid, p]) => {
        if(p.status === 'rest') return; // íœ´ë©´ ê³„ì •ì€ ë­í‚¹ì—ì„œ ì œì™¸í•˜ë ¤ë©´ ì´ ì¤„ ìœ ì§€, í¬í•¨í•˜ë ¤ë©´ ì‚­ì œ
        let count = 0;
        for(let i=1; i<=lastDay; i++) {
            const dKey = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(allCheckins[dKey] && allCheckins[dKey][uid]) count++;
        }
        if(!grouped[count]) grouped[count] = [];
        grouped[count].push({ name: p.name, uid });
    });
    const sortedCounts = Object.keys(grouped).map(Number).sort((a,b) => b-a);
    let html = "";
    sortedCounts.forEach(count => {
        html += `
            <div class="group-container">
                <div class="group-header"><b>${count}íšŒ ì„±ê³µ</b> <span>${grouped[count].length}ëª…</span></div>
                <div class="group-body">${grouped[count].map(m => `<div class="member-tag">${m.name} (${m.uid})</div>`).join('')}</div>
            </div>`;
    });
    document.getElementById('groupList').innerHTML = html || "ë°ì´í„° ì—†ìŒ";
}

function renderAttendance(year, month) {
    const lastDay = new Date(year, month, 0).getDate();
    let head = '<tr><th>ì´ë¦„</th>';
    for(let i=1; i<=lastDay; i++) {
        const d = new Date(year, month-1, i);
        head += `<th class="${d.getDay()===0?'sun-col':''} ${d>today?'future-col':''}">${i}</th>`;
    }
    document.getElementById('atHead').innerHTML = head + '</tr>';

    let body = '';
    // ID ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ìˆ«ì ê¸°ì¤€)
    Object.entries(participants).sort((a,b)=> Number(a[0]) - Number(b[0])).forEach(([uid, p]) => {
        body += `<tr><td>${p.name} <span style="font-size:9px; color:#999">(${uid})</span></td>`;
        for(let i=1; i<=lastDay; i++) {
            const d = new Date(year, month-1, i);
            const dKey = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const ok = allCheckins[dKey] && allCheckins[dKey][uid];
            
            let cellContent = '';
            if(p.status === 'rest') cellContent = '<span style="color:#ccc;">íœ´</span>';
            else if(ok) cellContent = '<span style="color:blue; font-weight:bold;">O</span>';
            else cellContent = '<span style="color:red; opacity:0.3;">X</span>';

            if(d.getDay()===0) body += `<td class="sun-col">ì¼</td>`;
            else if(d > today) body += `<td class="future-col">-</td>`;
            else body += `<td>${cellContent}</td>`;
        }
        body += '</tr>';
    });
    document.getElementById('atBody').innerHTML = body;
}

// [NEW] íšŒì› ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderManageList() {
    const listDiv = document.getElementById('manageList');
    let html = '';
    
    Object.entries(participants).sort((a,b)=> Number(a[0]) - Number(b[0])).forEach(([uid, p]) => {
        const isRest = p.status === 'rest';
        html += `
            <div class="manage-row">
                <div class="manage-info">
                    <b style="width:30px;">${uid}</b>
                    <span>${p.name}</span>
                    <span class="status-badge ${isRest ? 'status-rest' : 'status-active'}">
                        ${isRest ? 'íœ´ë©´' : 'ì°¸ì—¬ì¤‘'}
                    </span>
                </div>
                <div>
                    <button class="btn-sm" style="background:#eee;" onclick="toggleStatus('${uid}', '${p.status}')">
                        ${isRest ? 'â–¶ ë³µê·€' : 'â¸ íœ´ì‹'}
                    </button>
                    <button class="btn-sm btn-danger" onclick="deleteUser('${uid}', '${p.name}')">ì‚­ì œ</button>
                </div>
            </div>
        `;
    });
    listDiv.innerHTML = html;
}

// [NEW] íšŒì› ë“±ë¡
function registerUser() {
    const id = document.getElementById('newUserId').value;
    const name = document.getElementById('newUserName').value;
    
    if(!id || !name) return alert("IDì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if(participants[id]) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.");

    firebaseDb.ref('participants/' + id).set({
        name: name,
        status: 'active', // ê¸°ë³¸ê°’: ì°¸ì—¬ì¤‘
        joinedAt: new Date().toISOString()
    }).then(() => {
        alert(`${name}ë‹˜ ë“±ë¡ ì™„ë£Œ!`);
        document.getElementById('newUserId').value = '';
        document.getElementById('newUserName').value = '';
    });
}

// [NEW] ìƒíƒœ ë³€ê²½ (ì°¸ì—¬ <-> íœ´ë©´)
function toggleStatus(uid, currentStatus) {
    const newStatus = currentStatus === 'rest' ? 'active' : 'rest';
    const msg = newStatus === 'active' ? 'ì°¸ì—¬(ìˆ™ë©´) ìƒíƒœë¡œ ë³€ê²½í• ê¹Œìš”?' : 'íœ´ë©´ ìƒíƒœë¡œ ë³€ê²½í• ê¹Œìš”?';
    if(confirm(msg)) {
        firebaseDb.ref('participants/' + uid).update({ status: newStatus });
    }
}

// [NEW] íšŒì› ì‚­ì œ
function deleteUser(uid, name) {
    if(confirm(`ì •ë§ [${name}] ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        firebaseDb.ref('participants/' + uid).remove();
    }
}

function downloadExcel() {
    const table = document.getElementById("attendanceTable");
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth() + 1;
    const fileName = `SRT_ì¶œì„ë¶€_${year}ë…„${month}ì›”.xls`;
    const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="utf-8"></head>
        <body><table>${table.innerHTML}</table></body>
        </html>
    `;
    const blob = new Blob([html], { type: "application/vnd.ms-excel" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    a.click();
    window.URL.revokeObjectURL(url);
}

function makeReport() {
    const y = viewDate.getFullYear(); const m = viewDate.getMonth()+1;
    const fee = document.getElementById('feeInput').value;
    const start = new Date(document.getElementById('startDateInput').value); start.setHours(0,0,0,0);
    const lastDay = new Date(y, m, 0).getDate();
    let total = 0; let res = `[${y}ë…„ ${m}ì›” ì •ì‚°]\n\n`;
    Object.entries(participants).sort((a,b)=> Number(a[0]) - Number(b[0])).forEach(([uid, p]) => {
        if(p.status === 'rest') return;
        let abs = 0;
        for(let i=1; i<=lastDay; i++){
            const d = new Date(y, m-1, i); d.setHours(0,0,0,0);
            if(d < start || d.getDay()===0 || d > today) continue;
            const dKey = `${y}-${String(m).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(!(allCheckins[dKey] && allCheckins[dKey][uid])) abs++;
        }
        if(abs > 0) { const money = abs * fee; total += money; res += `â€¢ ${p.name}: ${money.toLocaleString()}ì› (${abs}íšŒ)\n`; }
    });
    res += `\nì´ì•¡: ${total.toLocaleString()}ì›`;
    document.getElementById('reportText').innerText = res;
    document.getElementById('reportBox').style.display = 'block';
}

function changeTab(n) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    // í´ë¦­ëœ ë²„íŠ¼ ì°¾ê¸° (ì´ë²¤íŠ¸ íƒ€ê²Ÿì´ ë²„íŠ¼ì´ ì•„ë‹ ê²½ìš° ìƒìœ„ íƒìƒ‰)
    let target = event.target;
    if(target.tagName !== 'BUTTON') target = target.closest('button');
    target.classList.add('active');
    document.getElementById('tab-' + n).classList.add('active');
}
function copyReport() { navigator.clipboard.writeText(document.getElementById('reportText').innerText).then(()=>alert("ë³µì‚¬ë¨")); }
</script>
</body>
</html>