<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin - í†µí•©ë³¸</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
.header { text-align: center; color: white; margin-bottom: 25px; }
.tab-nav { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 12px; }
.tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: white; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; }
.tab-btn.active { background: white; color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
.card-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
.form-group select, .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; }
.btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
.attendance-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.attendance-table th, .attendance-table td { padding: 8px 4px; border: 1px solid #e0e0e0; text-align: center; }
.ranking-item { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 5px; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš™ï¸ SRT Challenge í†µí•© ê´€ë¦¬ì</h1>
        <p>ì¶œì„ ìˆ˜ì • ë° ì›”ë§ˆê° ë¦¬í¬íŠ¸</p>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" onclick="showTab('attendance')">ğŸ“… ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="showTab('edit')">âœï¸ ì¶œì„ìˆ˜ì •</button>
        <button class="tab-btn" onclick="showTab('report')">ğŸ’° ì •ì‚°ê´€ë¦¬</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <div class="card">
            <div class="card-title">ğŸ† ì´ë²ˆ ë‹¬ ì¶œì„ TOP 5</div>
            <div id="rankingList"></div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content">
        <div class="card" style="overflow-x: auto;">
            <div id="monthDisplay" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
            <table class="attendance-table">
                <thead id="attendanceHead"></thead>
                <tbody id="attendanceBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="card">
            <div class="card-title">âœï¸ ê³¼ê±° ì¶œì„ ê¸°ë¡ ìˆ˜ì •</div>
            <div class="form-group">
                <label>ë‚ ì§œ ì„ íƒ</label>
                <input type="date" id="manualDate">
            </div>
            <div class="form-group">
                <label>íšŒì› ì„ íƒ</label>
                <select id="manualUserSelect"></select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:#43a047;" onclick="saveManualCheckin(true)">ì¸ì¦ ì™„ë£Œ(O)</button>
                <button class="btn-primary" style="background:#e53935;" onclick="saveManualCheckin(false)">ì¸ì¦ ì·¨ì†Œ(X)</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">ğŸ‘¤ íšŒì› ìƒíƒœ ë³€ê²½ (íœ´ì‹/ì •ìƒ)</div>
            <div class="form-group">
                <label>ì°¸ê°€ì ì„ íƒ</label>
                <select id="statusPSelect"></select>
            </div>
            <div class="form-group">
                <label>ìƒíƒœ ì„ íƒ</label>
                <select id="statusValSelect">
                    <option value="normal">ì •ìƒ (í™œë™ì¤‘)</option>
                    <option value="rest">íœ´ì‹</option>
                </select>
            </div>
            <button class="btn-primary" onclick="changeMemberStatus()">ìƒíƒœ ë³€ê²½í•˜ê¸°</button>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ’¸ ì›”ë§ˆê° ì§•ìˆ˜ê¸ˆ ë¦¬í¬íŠ¸</div>
            <div class="form-group">
                <label>ë¯¸ì¶œì„ 1íšŒë‹¹ ë²Œê¸ˆì•¡ (ì›)</label>
                <input type="number" id="penaltyInput" value="5000">
            </div>
            <button class="btn-primary" onclick="makeReport()">í•´ë‹¹ ì›” ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="reportResultCard" class="card" style="display:none;">
            <div id="reportPrintArea"></div>
            <button class="btn-primary" style="background:#333;" onclick="copyReportText()">ğŸ“‹ ë¦¬í¬íŠ¸ ë‚´ìš© ë³µì‚¬</button>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜ ì„¤ì • (ì¤‘ë³µ ì„ ì–¸ ë°©ì§€)
let participants = {};
let allCheckins = {};
let firebaseDb; 
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// íƒ­ ì „í™˜ í•¨ìˆ˜
function showTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // í´ë¦­ëœ ë²„íŠ¼ ì°¾ê¸°
    const clickedBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent.includes(
        tabName === 'dashboard' ? 'ëŒ€ì‹œë³´ë“œ' : 
        tabName === 'attendance' ? 'ì¶œì„ë¶€' : 
        tabName === 'edit' ? 'ì¶œì„ìˆ˜ì •' : 'ì •ì‚°ê´€ë¦¬'
    ));
    if(clickedBtn) clickedBtn.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

// ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™”
function init() {
    firebase.initializeApp(firebaseConfig);
    firebaseDb = firebase.database();
    
    firebaseDb.ref("participants").on("value", snap => {
        participants = snap.val() || {};
        updateDropdowns();
        renderMain();
    });
    
    firebaseDb.ref("checkins").on("value", snap => {
        allCheckins = snap.val() || {};
        renderMain();
    });
}

function updateDropdowns() {
    const ids = ['manualUserSelect', 'statusPSelect'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = '<option value="">-- íšŒì› ì„ íƒ --</option>';
        Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
            el.innerHTML += `<option value="${uid}">${uid}. ${p.name}</option>`;
        });
    });
}

function renderMain() {
    // ë­í‚¹ & ì¶œì„ë¶€ ë Œë”ë§ ë¡œì§ (ìƒëµ ê°€ëŠ¥í•˜ë‚˜ ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ í¬í•¨)
    const rankList = document.getElementById('rankingList');
    if(rankList) {
        rankList.innerHTML = '';
        // ì´ë²ˆë‹¬ ì¶œì„ ì¹´ìš´íŠ¸ ë¡œì§...
    }
    
    // ì¶œì„ë¶€ í…Œì´ë¸” ìƒì„±
    const display = document.getElementById('monthDisplay');
    if(display) display.innerText = `${currentYear}ë…„ ${currentMonth}ì›” í˜„í™©`;
    // ... í…Œì´ë¸” ë Œë”ë§ ì½”ë“œ ...
}

// ê¸°ëŠ¥ 1: ìˆ˜ë™ ì¶œì„ ìˆ˜ì •
async function saveManualCheckin(isPresent) {
    const date = document.getElementById('manualDate').value;
    const uid = document.getElementById('manualUserSelect').value;
    
    if(!date || !uid) return alert("ë‚ ì§œì™€ íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    
    const path = `checkins/${date}/${uid}`;
    if(isPresent) {
        await firebaseDb.ref(path).set({ name: participants[uid].name, timestamp: Date.now() });
        alert(`${date}ì¼ ì¶œì„ ì²˜ë¦¬ ì™„ë£Œ`);
    } else {
        await firebaseDb.ref(path).remove();
        alert(`${date}ì¼ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ`);
    }
}

// ê¸°ëŠ¥ 2: íšŒì› ìƒíƒœ ë³€ê²½
async function changeMemberStatus() {
    const uid = document.getElementById('statusPSelect').value;
    const val = document.getElementById('statusValSelect').value;
    if(!uid) return alert("íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");
    
    await firebaseDb.ref(`participants/${uid}/status`).set(val);
    alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// ê¸°ëŠ¥ 3: ì •ì‚° ë¦¬í¬íŠ¸ ìƒì„±
function makeReport() {
    const penalty = document.getElementById('penaltyInput').value;
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    let totalPenalty = 0;
    let html = `<h3 style="text-align:center;">[${currentMonth}ì›” ì§•ìˆ˜ ë¦¬í¬íŠ¸]</h3><hr style="margin:10px 0;">`;

    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([id, p]) => {
        if(p.status === 'rest') return;
        
        let absentDays = 0;
        for(let d=1; d<=daysInMonth; d++) {
            const dKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            if(!(allCheckins[dKey] && allCheckins[dKey][id])) absentDays++;
        }
        
        const money = absentDays * penalty;
        totalPenalty += money;
        html += `<div class="ranking-item"><span>${p.name} (ë¯¸ì¸ì¦ ${absentDays}íšŒ)</span><b>${money.toLocaleString()}ì›</b></div>`;
    });

    html += `<hr style="margin:10px 0;"><div style="text-align:right; font-weight:bold; color:red;">ì´í•©ê³„: ${totalPenalty.toLocaleString()}ì›</div>`;
    
    const resCard = document.getElementById('reportResultCard');
    document.getElementById('reportPrintArea').innerHTML = html;
    resCard.style.display = 'block';
}

function copyReportText() {
    const text = document.getElementById('reportPrintArea').innerText;
    navigator.clipboard.writeText(text).then(() => alert("ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¨í†¡ë°©ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!"));
}

window.onload = init;
</script>
</body>
</html>
