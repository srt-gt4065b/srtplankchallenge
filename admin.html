<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin - í†µí•© ê´€ë¦¬ì</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
/* ê¸°ì¡´ admin (5).htmlì˜ ìŠ¤íƒ€ì¼ì„ 100% ê³„ìŠ¹í•©ë‹ˆë‹¤ */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
.header { text-align: center; color: white; margin-bottom: 25px; }
.tab-nav { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 12px; }
.tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: white; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; }
.tab-btn.active { background: white; color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
.card-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.dashboard-card { background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
.dashboard-number { font-size: 36px; font-weight: 700; color: #667eea; }
.attendance-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.attendance-table th, .attendance-table td { padding: 8px 4px; border: 1px solid #e0e0e0; text-align: center; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
.form-group select, .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; }
.btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
.ranking-item { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 5px; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš™ï¸ SRT Challenge ê´€ë¦¬ì (ê¹€ë¯¸ì˜)</h1>
        <p>í†µí•© ë°ì´í„° ìˆ˜ì • ë° ë¦¬í¬íŠ¸ ê´€ë¦¬</p>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="changeTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" onclick="changeTab('attendance')">ğŸ“… ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="changeTab('edit')">âœï¸ ê¸°ë¡ìˆ˜ì •</button>
        <button class="tab-btn" onclick="changeTab('report')">ğŸ’° ì›”ë§ˆê°</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <div class="dashboard-grid">
            <div class="dashboard-card"><div class="dashboard-number" id="countTotal">0</div><div style="font-size:13px; color:#888;">ì „ì²´ íšŒì›</div></div>
            <div class="dashboard-card"><div class="dashboard-number" style="color:#43a047;" id="countToday">0</div><div style="font-size:13px; color:#888;">ì˜¤ëŠ˜ ì¸ì¦</div></div>
        </div>
        <div class="card" style="margin-top:20px;">
            <div class="card-title">ğŸ† ì´ë²ˆ ë‹¬ ì¶œì„ TOP 5</div>
            <div id="rankList"></div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content">
        <div class="card" style="overflow-x: auto;">
            <div id="monthLabel" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
            <table class="attendance-table">
                <thead id="atHead"></thead>
                <tbody id="atBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="card">
            <div class="card-title">âœï¸ íŠ¹ì •ì¼ ì¸ì¦ ê°•ì œ ìˆ˜ì •</div>
            <div class="form-group"><label>ë‚ ì§œ ì„ íƒ</label><input type="date" id="inputDate"></div>
            <div class="form-group"><label>íšŒì› ì„ íƒ</label><select id="inputUser"></select></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:#43a047;" onclick="doManual(true)">ì¸ì¦ ì™„ë£Œ ì²˜ë¦¬</button>
                <button class="btn-primary" style="background:#e53935;" onclick="doManual(false)">ì¸ì¦ ì·¨ì†Œ(ì‚­ì œ)</button>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ‘¤ íšŒì› ìƒíƒœ ë³€ê²½</div>
            <div class="form-group"><label>íšŒì› ì„ íƒ</label><select id="statusUser"></select></div>
            <div class="form-group"><label>ìƒíƒœ ì„ íƒ</label><select id="statusVal"><option value="normal">ì •ìƒ</option><option value="rest">íœ´ì‹</option></select></div>
            <button class="btn-primary" onclick="doStatus()">ìƒíƒœ ì €ì¥</button>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ’° ì›”ë§ ì§•ìˆ˜ê¸ˆ ë¦¬í¬íŠ¸</div>
            <div class="form-group"><label>ë¯¸ì¶œì„ 1íšŒë‹¹ ë²Œê¸ˆ(ì›)</label><input type="number" id="feeInput" value="5000"></div>
            <button class="btn-primary" onclick="makeReport()">í•´ë‹¹ ì›” ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="reportBox" class="card" style="display:none;">
            <div id="reportText"></div>
            <button class="btn-primary" style="background:#333;" onclick="copyReport()">ë¦¬í¬íŠ¸ ë³µì‚¬í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let participants = {};
let allCheckins = {};
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;
let firebaseDb;

// íƒ­ ì „í™˜
function changeTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

// ì´ˆê¸°í™” (Firebase ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€ ë¡œì§ í¬í•¨)
function init() {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    firebaseDb = firebase.database();
    
    // ì°¸ê°€ì ë°ì´í„° ì‹¤ì‹œê°„ ì—°ë™
    firebaseDb.ref("participants").on("value", snap => {
        participants = snap.val() || {};
        updateDropdowns();
        refresh();
    });
    
    // ì¸ì¦ ë°ì´í„° ì‹¤ì‹œê°„ ì—°ë™
    firebaseDb.ref("checkins").on("value", snap => {
        allCheckins = snap.val() || {};
        refresh();
    });
}

function updateDropdowns() {
    ['inputUser', 'statusUser'].forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = '<option value="">-- íšŒì› ì„ íƒ --</option>';
        Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
            el.innerHTML += `<option value="${uid}">${uid}. ${p.name}</option>`;
        });
    });
}

function refresh() {
    // 1. ëŒ€ì‹œë³´ë“œ ì¹´ìš´íŠ¸
    document.getElementById('countTotal').innerText = Object.keys(participants).length;
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('countToday').innerText = Object.keys(allCheckins[today] || {}).length;

    // 2. ë­í‚¹ TOP 5
    const counts = {};
    Object.keys(allCheckins).forEach(date => {
        if(date.startsWith(`${currentYear}-${String(currentMonth).padStart(2,'0')}`)) {
            Object.keys(allCheckins[date]).forEach(uid => counts[uid] = (counts[uid] || 0) + 1);
        }
    });
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    document.getElementById('rankList').innerHTML = sorted.map(([uid, c]) => 
        `<div class="ranking-item"><span>${participants[uid]?.name || uid}</span><b>${c}íšŒ</b></div>`).join('');

    // 3. ì¶œì„ë¶€ í…Œì´ë¸”
    document.getElementById('monthLabel').innerText = `${currentYear}ë…„ ${currentMonth}ì›”`;
    const lastDay = new Date(currentYear, currentMonth, 0).getDate();
    let head = '<tr><th>ì´ë¦„</th>';
    for(let i=1; i<=lastDay; i++) head += `<th>${i}</th>`;
    head += '</tr>';
    document.getElementById('atHead').innerHTML = head;

    let body = '';
    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        body += `<tr><td>${p.name}</td>`;
        for(let i=1; i<=lastDay; i++) {
            const dKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const ok = allCheckins[dKey] && allCheckins[dKey][uid];
            body += `<td>${p.status==='rest'?'íœ´':(ok?'O':'X')}</td>`;
        }
        body += '</tr>';
    });
    document.getElementById('atBody').innerHTML = body;
}

// ê¸°ëŠ¥: ìˆ˜ë™ ì¸ì¦ ìˆ˜ì •
async function doManual(isPresent) {
    const date = document.getElementById('inputDate').value;
    const uid = document.getElementById('inputUser').value;
    if(!date || !uid) return alert("ë‚ ì§œì™€ íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");

    const path = `checkins/${date}/${uid}`;
    if(isPresent) {
        await firebaseDb.ref(path).set({ name: participants[uid].name, timestamp: Date.now() });
        alert("ì¸ì¦ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
        await firebaseDb.ref(path).remove();
        alert("ì¸ì¦ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
}

// ê¸°ëŠ¥: ìƒíƒœ ë³€ê²½
async function doStatus() {
    const uid = document.getElementById('statusUser').value;
    const val = document.getElementById('statusVal').value;
    if(!uid) return alert("íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");
    await firebaseDb.ref(`participants/${uid}/status`).set(val);
    alert("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// ê¸°ëŠ¥: ë¦¬í¬íŠ¸ ìƒì„±
function makeReport() {
    const fee = document.getElementById('feeInput').value;
    const lastDay = new Date(currentYear, currentMonth, 0).getDate();
    let total = 0;
    let html = `<h3>[${currentMonth}ì›” ìµœì¢… ì§•ìˆ˜ ë¦¬í¬íŠ¸]</h3><br>`;

    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        if(p.status === 'rest') return;
        let absent = 0;
        for(let i=1; i<=lastDay; i++) {
            const d = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(!(allCheckins[d] && allCheckins[d][uid])) absent++;
        }
        const penalty = absent * fee;
        total += penalty;
        html += `<div class="ranking-item"><span>${p.name} (ë¯¸ë‹¬ ${absent}íšŒ)</span><b>${penalty.toLocaleString()}ì›</b></div>`;
    });
    html += `<br><div style="text-align:right; font-weight:bold; color:red;">ì´ ì§•ìˆ˜ì•¡: ${total.toLocaleString()}ì›</div>`;
    
    document.getElementById('reportText').innerHTML = html;
    document.getElementById('reportBox').style.display = 'block';
}

function copyReport() {
    const txt = document.getElementById('reportText').innerText;
    navigator.clipboard.writeText(txt).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
}

window.onload = init;
</script>
</body>
</html>
