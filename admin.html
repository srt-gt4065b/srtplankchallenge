<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 800px;
    margin: 0 auto;
}

/* í—¤ë” */
.header {
    text-align: center;
    color: white;
    margin-bottom: 25px;
}

.header h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
}

.header p {
    font-size: 14px;
    opacity: 0.9;
}

/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
.tab-nav {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    background: rgba(255,255,255,0.2);
    padding: 5px;
    border-radius: 12px;
}

.tab-btn {
    flex: 1;
    padding: 12px;
    background: transparent;
    border: none;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
}

.tab-btn.active {
    background: white;
    color: #667eea;
}

.tab-btn:hover:not(.active) {
    background: rgba(255,255,255,0.2);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

.card-title {
    font-size: 16px;
    font-weight: 700;
    color: #333;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-title .icon {
    font-size: 20px;
}

/* í†µê³„ ëŒ€ì‹œë³´ë“œ */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.dashboard-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    text-align: center;
}

.dashboard-card.full-width {
    grid-column: span 2;
}

.dashboard-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.dashboard-number {
    font-size: 36px;
    font-weight: 700;
    color: #667eea;
}

.dashboard-number.warning {
    color: #f57c00;
}

.dashboard-number.danger {
    color: #e53935;
}

.dashboard-number.success {
    color: #43a047;
}

.dashboard-label {
    font-size: 13px;
    color: #888;
    margin-top: 5px;
}

/* ì›” ì„ íƒ */
.month-selector {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
}

.month-btn {
    padding: 8px 15px;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
}

.month-btn:hover {
    background: rgba(255,255,255,0.3);
}

.month-display {
    color: white;
    font-size: 18px;
    font-weight: 700;
    min-width: 150px;
    text-align: center;
}

/* ì¶œì„ë¶€ í…Œì´ë¸” */
.attendance-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

.attendance-table th,
.attendance-table td {
    padding: 8px 4px;
    text-align: center;
    border: 1px solid #e0e0e0;
}

.attendance-table th {
    background: #f5f5f5;
    font-weight: 600;
    color: #333;
}

.attendance-table th.name-col {
    min-width: 60px;
    position: sticky;
    left: 0;
    background: #f5f5f5;
    z-index: 1;
}

.attendance-table td.name-col {
    position: sticky;
    left: 0;
    background: white;
    font-weight: 500;
    z-index: 1;
}

.attendance-table .day-header {
    min-width: 28px;
}

.attendance-table .present {
    background: #e3f2fd;
    color: #1976d2;
}

.attendance-table .absent {
    background: #ffebee;
    color: #c62828;
}

.attendance-table .rest {
    background: #fff3e0;
    color: #f57c00;
}

.attendance-table .future {
    background: #fafafa;
    color: #ccc;
}

.table-wrapper {
    overflow-x: auto;
    margin-bottom: 15px;
}

/* ê²°ì„ì ë¦¬ìŠ¤íŠ¸ */
.absent-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
}

.absent-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background: #ffebee;
    border-radius: 10px;
    border-left: 4px solid #e53935;
}

.absent-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.absent-num {
    width: 28px;
    height: 28px;
    background: #e53935;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.absent-name {
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.absent-count {
    font-size: 14px;
    font-weight: 700;
    color: #e53935;
}

/* ìƒíƒœ ë³€ê²½ í¼ */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 6px;
    font-weight: 500;
}

.form-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 14px;
    color: #333;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s;
}

.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.btn-primary {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

/* ì•Œë¦¼ ë©”ì‹œì§€ */
.alert {
    padding: 12px 15px;
    border-radius: 10px;
    margin-top: 15px;
    font-size: 14px;
    display: none;
}

.alert.success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
    display: block;
}

/* ì°¸ê°€ì ëª©ë¡ */
.participant-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.participant-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.participant-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.participant-num {
    width: 28px;
    height: 28px;
    background: #667eea;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.participant-name {
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
}

.status-badge.normal {
    background: #e3f2fd;
    color: #1976d2;
}

.status-badge.rest {
    background: #fff3e0;
    color: #f57c00;
}

/* ë­í‚¹ */
.ranking-list {
    counter-reset: ranking;
}

.ranking-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 8px;
}

.ranking-item::before {
    counter-increment: ranking;
    content: counter(ranking);
    width: 28px;
    height: 28px;
    background: #667eea;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    margin-right: 12px;
}

.ranking-item:nth-child(1)::before {
    background: linear-gradient(135deg, #FFD700, #FFA500);
}

.ranking-item:nth-child(2)::before {
    background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
}

.ranking-item:nth-child(3)::before {
    background: linear-gradient(135deg, #CD7F32, #A0522D);
}

.ranking-name {
    flex: 1;
    font-weight: 500;
}

.ranking-score {
    font-weight: 700;
    color: #667eea;
}

/* í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° */
.back-link {
    display: block;
    text-align: center;
    color: white;
    text-decoration: none;
    font-size: 14px;
    opacity: 0.9;
    margin-top: 10px;
}

.back-link:hover {
    opacity: 1;
    text-decoration: underline;
}

/* ë²”ë¡€ */
.legend {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 10px;
    font-size: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.legend-color.present { background: #e3f2fd; }
.legend-color.absent { background: #ffebee; }
.legend-color.rest { background: #fff3e0; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âš™ï¸ SRT Challenge ê´€ë¦¬ì</h1>
        <p>ì¶œì„ í˜„í™© ë° ì°¸ê°€ì ê´€ë¦¬</p>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" onclick="showTab('attendance')">ğŸ“… ì›”ë³„ ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="showTab('manage')">ğŸ‘¤ íšŒì›ê´€ë¦¬</button>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
    <div id="tab-dashboard" class="tab-content active">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="dashboard-icon">ğŸ‘¥</div>
                <div class="dashboard-number" id="dashTotalMembers">24</div>
                <div class="dashboard-label">ì „ì²´ íšŒì›</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-icon">ğŸƒ</div>
                <div class="dashboard-number" id="dashActiveMembers">0</div>
                <div class="dashboard-label">í™œë™ì¤‘</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-icon">âœ…</div>
                <div class="dashboard-number success" id="dashTodayPresent">0</div>
                <div class="dashboard-label">ì˜¤ëŠ˜ ì¶œì„</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-icon">âŒ</div>
                <div class="dashboard-number danger" id="dashTodayAbsent">0</div>
                <div class="dashboard-label">ì˜¤ëŠ˜ ë¯¸ì¶œì„</div>
            </div>
            <div class="dashboard-card full-width">
                <div class="dashboard-icon">ğŸ“ˆ</div>
                <div class="dashboard-number" id="dashMonthlyRate">0%</div>
                <div class="dashboard-label">ì´ë²ˆ ë‹¬ í‰ê·  ì¶œì„ë¥ </div>
            </div>
        </div>

        <!-- ì¶œì„ ë­í‚¹ -->
        <div class="card">
            <div class="card-title"><span class="icon">ğŸ†</span> ì´ë²ˆ ë‹¬ ì¶œì„ ë­í‚¹ TOP 5</div>
            <div class="ranking-list" id="rankingList"></div>
        </div>

        <!-- ì˜¤ëŠ˜ ê²°ì„ì -->
        <div class="card">
            <div class="card-title"><span class="icon">âš ï¸</span> ì˜¤ëŠ˜ ë¯¸ì¶œì„ì</div>
            <div class="absent-list" id="todayAbsentList"></div>
            <p id="noAbsentMsg" style="text-align:center; color:#888; padding:20px; display:none;">ëª¨ë‘ ì¶œì„í–ˆìŠµë‹ˆë‹¤! ğŸ‰</p>
        </div>
    </div>

    <!-- ì›”ë³„ ì¶œì„ë¶€ íƒ­ -->
    <div id="tab-attendance" class="tab-content">
        <div class="month-selector">
            <button class="month-btn" onclick="changeMonth(-1)">â—€</button>
            <div class="month-display" id="monthDisplay">2025ë…„ 12ì›”</div>
            <button class="month-btn" onclick="changeMonth(1)">â–¶</button>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">ğŸ“‹</span> ì›”ë³„ ì¶œì„ë¶€</div>
            <div class="table-wrapper">
                <table class="attendance-table" id="attendanceTable">
                    <thead id="attendanceHead"></thead>
                    <tbody id="attendanceBody"></tbody>
                </table>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color present"></div> ì¶œì„</div>
                <div class="legend-item"><div class="legend-color absent"></div> ê²°ì„</div>
                <div class="legend-item"><div class="legend-color rest"></div> íœ´ì‹</div>
            </div>
        </div>

        <!-- ì›”ë³„ ê²°ì„ì í†µê³„ -->
        <div class="card">
            <div class="card-title"><span class="icon">ğŸ“Š</span> ì›”ë³„ ê²°ì„ íšŸìˆ˜</div>
            <div class="absent-list" id="monthlyAbsentList"></div>
        </div>
    </div>

    <!-- íšŒì›ê´€ë¦¬ íƒ­ -->
    <div id="tab-manage" class="tab-content">
        <div class="card">
            <div class="card-title"><span class="icon">ğŸ‘¤</span> íšŒì› ìƒíƒœ ë³€ê²½</div>
            
            <div class="form-group">
                <label>ì°¸ê°€ì ì„ íƒ</label>
                <select id="pSelect">
                    <option value="">-- ì°¸ê°€ìë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ìƒíƒœ ì„ íƒ</label>
                <select id="statusSelect">
                    <option value="normal">ì •ìƒ (í™œë™ì¤‘)</option>
                    <option value="rest">íœ´ì‹</option>
                </select>
            </div>
            
            <button class="btn-primary" onclick="updateStatus()">ìƒíƒœ ë³€ê²½í•˜ê¸°</button>
            
            <div class="alert" id="statusMsg"></div>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">ğŸ‘¥</span> ì°¸ê°€ì ëª©ë¡</div>
            <div class="participant-list" id="participantList"></div>
        </div>
    </div>

    <a href="index.html" class="back-link">â† ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script>
// ê¸°ë³¸ ì°¸ê°€ì ë°ì´í„°
const defaultParticipants = {
    1: { name: 'ê¹€í˜•íƒœ', status: 'normal' },
    2: { name: 'ê¹€ë¯¸ì˜', status: 'normal' },
    3: { name: 'ê¹€í˜¸ì¢…', status: 'normal' },
    4: { name: 'ê¹€ìƒë‚¨', status: 'normal' },
    5: { name: 'ê¹€í˜„í¬', status: 'normal' },
    6: { name: 'ì´ë¯¸ìˆ™', status: 'normal' },
    7: { name: 'ì†Œë³‘ë“', status: 'normal' },
    8: { name: 'ë°•ì€ì •', status: 'normal' },
    9: { name: 'ê¹€ë§Œí™˜', status: 'normal' },
    10: { name: 'ìœ¤ì¢…ì„', status: 'normal' },
    11: { name: 'ë°•ì°½ì„ ', status: 'normal' },
    12: { name: 'ë°•ê²½í˜„', status: 'normal' },
    13: { name: 'ê¹€ìœ ì„±', status: 'normal' },
    14: { name: 'ì•ˆì§€í›ˆ', status: 'normal' },
    15: { name: 'ê¹€ë¯¼ì£¼', status: 'normal' },
    16: { name: 'ë°•ë¬´ì˜', status: 'normal' },
    17: { name: 'ê¹€ë³‘ê¸°', status: 'normal' },
    18: { name: 'ê¹€ì¬ì‚°', status: 'normal' },
    19: { name: 'ê°•ë™í˜„', status: 'normal' },
    20: { name: 'ì†ë¯¸ì—°', status: 'normal' },
    21: { name: 'ì´ê²½ë¯¼', status: 'normal' },
    22: { name: 'ê°•í˜„ì •', status: 'normal' },
    23: { name: 'ë°•ì§„í¬', status: 'normal' },
    24: { name: 'ì•ˆê¸¸ì„', status: 'normal' }
};

let participants = {};
let allCheckins = {};
let db;
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// íƒ­ ì „í™˜
function showTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
    
    if (tabName === 'attendance') {
        renderAttendanceTable();
    }
}

// Firebase ì´ˆê¸°í™”
function initFirebase() {
    if (typeof firebase !== 'undefined' && firebase.database) {
        db = firebase.database();
        loadAllData();
    } else {
        participants = defaultParticipants;
        renderAll();
    }
}

// ëª¨ë“  ë°ì´í„° ë¡œë“œ
function loadAllData() {
    // ì°¸ê°€ì ë°ì´í„°
    db.ref("participants").on("value", snap => {
        const data = snap.val();
        if (data) {
            participants = data;
        } else {
            participants = defaultParticipants;
            db.ref("participants").set(defaultParticipants);
        }
        renderAll();
    });
    
    // ì „ì²´ ì²´í¬ì¸ ë°ì´í„°
    db.ref("checkins").on("value", snap => {
        allCheckins = snap.val() || {};
        renderAll();
    });
}

// ì „ì²´ ë Œë”ë§
function renderAll() {
    renderDashboard();
    renderSelect();
    renderParticipantList();
    renderAttendanceTable();
}

// ëŒ€ì‹œë³´ë“œ ë Œë”ë§
function renderDashboard() {
    const total = Object.keys(participants).length;
    let activeCount = 0;
    let restCount = 0;
    
    Object.values(participants).forEach(p => {
        if (p.status === 'rest') restCount++;
        else activeCount++;
    });
    
    // ì˜¤ëŠ˜ ì¶œì„ í˜„í™©
    const today = getTodayKey();
    const todayCheckins = allCheckins[today] || {};
    const todayPresentCount = Object.keys(todayCheckins).length;
    const todayAbsentCount = activeCount - todayPresentCount;
    
    document.getElementById('dashTotalMembers').textContent = total;
    document.getElementById('dashActiveMembers').textContent = activeCount;
    document.getElementById('dashTodayPresent').textContent = todayPresentCount;
    document.getElementById('dashTodayAbsent').textContent = Math.max(0, todayAbsentCount);
    
    // ì›”ë³„ ì¶œì„ë¥  ê³„ì‚°
    const monthlyRate = calculateMonthlyRate();
    document.getElementById('dashMonthlyRate').textContent = monthlyRate + '%';
    
    // ì¶œì„ ë­í‚¹
    renderRanking();
    
    // ì˜¤ëŠ˜ ë¯¸ì¶œì„ì
    renderTodayAbsent(todayCheckins);
}

// ì˜¤ëŠ˜ ë‚ ì§œ í‚¤
function getTodayKey() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ì›”ë³„ ì¶œì„ë¥  ê³„ì‚°
function calculateMonthlyRate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const currentDay = today.getDate();
    
    let totalExpected = 0;
    let totalPresent = 0;
    
    const activeMembers = Object.entries(participants).filter(([id, p]) => p.status !== 'rest');
    
    for (let day = 1; day <= currentDay; day++) {
        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayCheckins = allCheckins[dateKey] || {};
        
        totalExpected += activeMembers.length;
        totalPresent += Object.keys(dayCheckins).filter(id => {
            const p = participants[id];
            return p && p.status !== 'rest';
        }).length;
    }
    
    if (totalExpected === 0) return 0;
    return Math.round((totalPresent / totalExpected) * 100);
}

// ì¶œì„ ë­í‚¹ ë Œë”ë§
function renderRanking() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const currentDay = today.getDate();
    
    // ê° ì°¸ê°€ìë³„ ì¶œì„ íšŸìˆ˜ ê³„ì‚°
    const attendanceCounts = {};
    Object.keys(participants).forEach(id => {
        attendanceCounts[id] = 0;
    });
    
    for (let day = 1; day <= currentDay; day++) {
        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayCheckins = allCheckins[dateKey] || {};
        
        Object.keys(dayCheckins).forEach(id => {
            if (attendanceCounts[id] !== undefined) {
                attendanceCounts[id]++;
            }
        });
    }
    
    // ì •ë ¬
    const sorted = Object.entries(attendanceCounts)
        .map(([id, count]) => ({ id, name: participants[id]?.name || '', count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);
    
    const list = document.getElementById('rankingList');
    list.innerHTML = '';
    
    sorted.forEach(item => {
        const div = document.createElement('div');
        div.className = 'ranking-item';
        div.innerHTML = `
            <span class="ranking-name">${item.id}. ${item.name}</span>
            <span class="ranking-score">${item.count}ì¼</span>
        `;
        list.appendChild(div);
    });
}

// ì˜¤ëŠ˜ ë¯¸ì¶œì„ì ë Œë”ë§
function renderTodayAbsent(todayCheckins) {
    const list = document.getElementById('todayAbsentList');
    const noMsg = document.getElementById('noAbsentMsg');
    list.innerHTML = '';
    
    const absentMembers = [];
    
    Object.entries(participants).forEach(([id, p]) => {
        if (p.status !== 'rest' && !todayCheckins[id]) {
            absentMembers.push({ id, name: p.name });
        }
    });
    
    if (absentMembers.length === 0) {
        noMsg.style.display = 'block';
        return;
    }
    
    noMsg.style.display = 'none';
    
    absentMembers.forEach(member => {
        const div = document.createElement('div');
        div.className = 'absent-item';
        div.innerHTML = `
            <div class="absent-info">
                <div class="absent-num">${member.id}</div>
                <div class="absent-name">${member.name}</div>
            </div>
        `;
        list.appendChild(div);
    });
}

// ì›” ë³€ê²½
function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    
    document.getElementById('monthDisplay').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
    renderAttendanceTable();
}

// ì¶œì„ë¶€ í…Œì´ë¸” ë Œë”ë§
function renderAttendanceTable() {
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    const today = new Date();
    const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth;
    const currentDay = isCurrentMonth ? today.getDate() : daysInMonth;
    
    // í—¤ë”
    const thead = document.getElementById('attendanceHead');
    let headerHTML = '<tr><th class="name-col">ì´ë¦„</th>';
    for (let day = 1; day <= daysInMonth; day++) {
        headerHTML += `<th class="day-header">${day}</th>`;
    }
    headerHTML += '<th>ì¶œì„</th><th>ê²°ì„</th></tr>';
    thead.innerHTML = headerHTML;
    
    // ë°”ë””
    const tbody = document.getElementById('attendanceBody');
    tbody.innerHTML = '';
    
    // ì›”ë³„ ê²°ì„ í†µê³„ ì €ì¥
    const absentStats = {};
    
    Object.entries(participants).sort((a, b) => Number(a[0]) - Number(b[0])).forEach(([id, p]) => {
        let presentCount = 0;
        let absentCount = 0;
        
        let rowHTML = `<tr><td class="name-col">${p.name}</td>`;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayCheckins = allCheckins[dateKey] || {};
            
            if (day > currentDay && isCurrentMonth) {
                rowHTML += '<td class="future">-</td>';
            } else if (p.status === 'rest') {
                rowHTML += '<td class="rest">íœ´</td>';
            } else if (dayCheckins[id]) {
                rowHTML += '<td class="present">O</td>';
                presentCount++;
            } else {
                rowHTML += '<td class="absent">X</td>';
                absentCount++;
            }
        }
        
        rowHTML += `<td><strong>${presentCount}</strong></td>`;
        rowHTML += `<td><strong style="color:#e53935">${absentCount}</strong></td>`;
        rowHTML += '</tr>';
        
        tbody.innerHTML += rowHTML;
        
        if (absentCount > 0 && p.status !== 'rest') {
            absentStats[id] = { name: p.name, count: absentCount };
        }
    });
    
    // ì›”ë³„ ê²°ì„ì í†µê³„ ë Œë”ë§
    renderMonthlyAbsent(absentStats);
}

// ì›”ë³„ ê²°ì„ì í†µê³„ ë Œë”ë§
function renderMonthlyAbsent(absentStats) {
    const list = document.getElementById('monthlyAbsentList');
    list.innerHTML = '';
    
    const sorted = Object.entries(absentStats)
        .sort((a, b) => b[1].count - a[1].count);
    
    if (sorted.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">ê²°ì„ìê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</p>';
        return;
    }
    
    sorted.forEach(([id, data]) => {
        const div = document.createElement('div');
        div.className = 'absent-item';
        div.innerHTML = `
            <div class="absent-info">
                <div class="absent-num">${id}</div>
                <div class="absent-name">${data.name}</div>
            </div>
            <div class="absent-count">${data.count}íšŒ ê²°ì„</div>
        `;
        list.appendChild(div);
    });
}

// ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë Œë”ë§
function renderSelect() {
    const sel = document.getElementById("pSelect");
    sel.innerHTML = '<option value="">-- ì°¸ê°€ìë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
    
    Object.keys(participants).sort((a, b) => Number(a) - Number(b)).forEach(id => {
        const p = participants[id];
        const statusText = p.status === 'rest' ? ' (íœ´ì‹ì¤‘)' : '';
        sel.innerHTML += `<option value="${id}">${id}. ${p.name}${statusText}</option>`;
    });
}

// ì°¸ê°€ì ëª©ë¡ ë Œë”ë§
function renderParticipantList() {
    const list = document.getElementById("participantList");
    list.innerHTML = '';
    
    Object.keys(participants).sort((a, b) => Number(a) - Number(b)).forEach(id => {
        const p = participants[id];
        const statusClass = p.status === 'rest' ? 'rest' : 'normal';
        const statusText = p.status === 'rest' ? 'íœ´ì‹' : 'í™œë™';
        
        list.innerHTML += `
            <div class="participant-item">
                <div class="participant-info">
                    <div class="participant-num">${id}</div>
                    <div class="participant-name">${p.name}</div>
                </div>
                <div class="status-badge ${statusClass}">${statusText}</div>
            </div>
        `;
    });
}

// ìƒíƒœ ë³€ê²½
function updateStatus() {
    const id = document.getElementById("pSelect").value;
    const status = document.getElementById("statusSelect").value;
    const msgEl = document.getElementById("statusMsg");
    
    if (!id) {
        msgEl.className = 'alert';
        msgEl.style.display = 'block';
        msgEl.style.background = '#ffebee';
        msgEl.style.color = '#c62828';
        msgEl.style.border = '1px solid #ef9a9a';
        msgEl.textContent = 'ì°¸ê°€ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
        return;
    }
    
    const name = participants[id].name;
    const statusText = status === 'rest' ? 'íœ´ì‹' : 'ì •ìƒ';
    
    if (db) {
        db.ref("participants/" + id).update({ status });
    } else {
        participants[id].status = status;
        renderAll();
    }
    
    msgEl.className = 'alert success';
    msgEl.innerHTML = `<strong>${id}. ${name}</strong>ë‹˜ì˜ ìƒíƒœê°€ <strong>'${statusText}'</strong>ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    
    setTimeout(() => {
        msgEl.style.display = 'none';
    }, 3000);
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('monthDisplay').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
    setTimeout(initFirebase, 500);
});
</script>

</body>
</html>
