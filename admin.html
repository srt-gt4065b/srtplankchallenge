<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Plank Challenge â€“ ADMIN</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>

<style>
body { font-family: sans-serif; margin: 20px; }
h2 { margin-top: 30px; }
.box { padding: 15px; background: #f3f3f3; border-radius: 10px; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { padding: 10px; border-bottom: 1px solid #ccc; }
th { background: #eaeaea; }
.good { color: green; font-weight: bold; }
.bad { color: red; font-weight: bold; }
.btn {
    padding: 10px 16px;
    background: #7B61FF;
    color: white;
    border-radius: 8px;
    border:none;
    cursor:pointer;
}
.btn2 {
    padding: 8px 12px;
    background: #555;
    color:white;
    border-radius:5px;
    border:none;
    cursor:pointer;
}
</style>
</head>

<body>

<h1>SRT Plank Challenge â€“ ADMIN</h1>

<div class="box">
    <h3>ğŸ“… íŠ¹ì • ë‚ ì§œ ì¸ì¦ í˜„í™© ì¡°íšŒ</h3>
    <input type="date" id="dateInput">
    <button class="btn" onclick="loadDaily()">ì¡°íšŒí•˜ê¸°</button>

    <div id="dailyResult"></div>
</div>

<div class="box">
    <h3>ğŸ“Š ì›”ë§ ì´ì •ë¦¬</h3>
    <input type="month" id="monthInput">
    <button class="btn" onclick="loadMonthly()">ì›” í†µê³„ ë³´ê¸°</button>

    <div id="monthlyResult"></div>
</div>

<script>
let participants = {};

// ì°¸ê°€ì ëª…ë‹¨ ë¡œë“œ
fetch("participants.json")
  .then(r => r.json())
  .then(data => { participants = data; });


// ---- 1) íŠ¹ì • ë‚ ì§œ ì¸ì¦ í˜„í™© ----
function loadDaily(){
    const dateKey = document.getElementById("dateInput").value;
    if(!dateKey){
        alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”");
        return;
    }

    const dailyDiv = document.getElementById("dailyResult");
    dailyDiv.innerHTML = "<p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

    db.ref("checkins/" + dateKey).once("value", snap => {

        let checked = new Set();
        let table = "<h3>ğŸ“… " + dateKey + " ì¸ì¦ í˜„í™©</h3>";
        table += "<table><tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ìƒíƒœ</th></tr>";

        snap.forEach(child=>{
            checked.add(String(child.val().userId));
        });

        Object.keys(participants).forEach(id=>{
            const p = participants[id];
            const isChecked = checked.has(id);

            table += `
                <tr>
                    <td>${id}</td>
                    <td>${p.name}</td>
                    <td class="${isChecked ? 'good' : 'bad'}">
                        ${isChecked ? "â— ì¸ì¦" : "â—‹ ë¯¸ì¸ì¦"}
                    </td>
                </tr>
            `;
        });

        table += "</table>";
        dailyDiv.innerHTML = table;
    });
}



// ---- 2) ì›”ë§ í†µê³„ ----
function loadMonthly(){
    const monthStr = document.getElementById("monthInput").value;
    if(!monthStr){
        alert("ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
        return;
    }

    const yyyy = monthStr.split("-")[0];
    const mm = monthStr.split("-")[1];
    const daysInMonth = new Date(yyyy, mm, 0).getDate();

    const monthlyDiv = document.getElementById("monthlyResult");
    monthlyDiv.innerHTML = "<p>ì›” ë°ì´í„° ë¡œë”© ì¤‘...</p>";

    let stats = {};
    Object.keys(participants).forEach(id=>{
        stats[id] = { 
            name: participants[id].name,
            checked: 0,
            missed: 0
        };
    });

    let fetchCount = 0;
    for(let d=1; d<=daysInMonth; d++){
        const dateKey = `${yyyy}-${String(mm).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

        db.ref("checkins/" + dateKey).once("value", snap=>{
            let dailyChecked = new Set();
            snap.forEach(child => dailyChecked.add(String(child.val().userId)));

            Object.keys(participants).forEach(id=>{
                if(dailyChecked.has(id)){
                    stats[id].checked++;
                } else {
                    stats[id].missed++;
                }
            });

            fetchCount++;
            if(fetchCount === daysInMonth){
                renderMonthly(stats, yyyy, mm, daysInMonth);
            }
        });
    }
}

// ì›”ë§ í†µê³„ ì¶œë ¥
function renderMonthly(stats, yyyy, mm, totalDays){
    let html = `<h3>${yyyy}ë…„ ${mm}ì›” ì¶œì„ í†µê³„</h3>`;
    html += `<table>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ì´ë¦„</th>
                    <th>ì¶œì„ì¼ìˆ˜</th>
                    <th>ëˆ„ë½ì¼ìˆ˜</th>
                    <th>ì¶œì„ë¥ </th>
                </tr>`;

    Object.keys(stats).forEach(id=>{
        const s = stats[id];
        const rate = ((s.checked / totalDays) * 100).toFixed(1);

        html += `
            <tr>
                <td>${id}</td>
                <td>${s.name}</td>
                <td>${s.checked}</td>
                <td class="${s.missed > 0 ? 'bad' : ''}">${s.missed}</td>
                <td>${rate}%</td>
            </tr>
        `;
    });

    html += "</table>";

    document.getElementById("monthlyResult").innerHTML = html;
}

</script>
</body>
</html>
