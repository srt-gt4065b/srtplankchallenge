<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRT Challenge Admin - ìµœì¢… ìˆ˜ì •ë³¸</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ 100% ë™ì¼ ìœ ì§€ */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
#login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.login-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 350px; }
.header { text-align: center; color: white; margin-bottom: 25px; }
.tab-nav { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 12px; }
.tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: white; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; }
.tab-btn.active { background: white; color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
.card-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.attendance-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.attendance-table th, .attendance-table td { padding: 6px 2px; border: 1px solid #e0e0e0; text-align: center; }
.attendance-table th { background: #f5f5f5; }
.sun-col { color: #e53935; background: #fff5f5 !important; font-weight: bold; }
.future-col { background: #fafafa; color: #ccc; }
.btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
.form-group { margin-bottom: 15px; text-align: left; }
.form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
.form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; }
.ranking-item { display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 10px; margin-bottom: 8px; font-size: 14px; border-left: 4px solid #667eea; }
.ranking-item b { color: #667eea; }
</style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h2 style="margin-bottom: 20px;">Admin ì ‘ì†</h2>
        <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="adminPw" onkeypress="if(event.keyCode==13) checkLogin()"></div>
        <button class="btn-primary" onclick="checkLogin()">ì ‘ì†í•˜ê¸°</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container" id="admin-main" style="display: none;">
    <div class="header">
        <h1>âš™ï¸ SRT Challenge ê´€ë¦¬ì</h1>
        <p>ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ ëŒ€ì‹œë³´ë“œ</p>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="changeTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" onclick="changeTab('attendance')">ğŸ“… ì¶œì„ë¶€</button>
        <button class="tab-btn" onclick="changeTab('edit')">âœï¸ ê¸°ë¡ìˆ˜ì •</button>
        <button class="tab-btn" onclick="changeTab('report')">ğŸ’° ì •ì‚°ê´€ë¦¬</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <div class="card">
            <div class="card-title">ğŸ† ì´ë²ˆ ë‹¬ ëˆ„ì  ì¶œì„ (ì¸ì¦ ì„±ê³µ íšŸìˆ˜)</div>
            <div id="rankList">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <div id="tab-attendance" class="tab-content">
        <div class="card" style="overflow-x: auto;">
            <div id="monthLabel" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
            <table class="attendance-table"><thead id="atHead"></thead><tbody id="atBody"></tbody></table>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="card">
            <div class="card-title">âœï¸ ì¸ì¦ ìˆ˜ë™ ê´€ë¦¬</div>
            <div class="form-group"><label>ë‚ ì§œ ì„ íƒ</label><input type="date" id="inputDate"></div>
            <div class="form-group"><label>íšŒì› ì„ íƒ</label><select id="inputUser"></select></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:#43a047;" onclick="doManual(true)">ì¸ì¦ ì²˜ë¦¬</button>
                <button class="btn-primary" style="background:#e53935;" onclick="doManual(false)">ì¸ì¦ ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="card">
            <div class="card-title">ğŸ’¸ ì •ì‚° ë¦¬í¬íŠ¸ ìƒì„±</div>
            <div class="form-group"><label>ì±Œë¦°ì§€ ì‹œì‘ì¼</label><input type="date" id="startDateInput"></div>
            <div class="form-group"><label>ë¯¸ì¶œì„ ë²Œê¸ˆ(ì›)</label><input type="number" id="feeInput" value="5000"></div>
            <button class="btn-primary" onclick="makeReport()">ë§ì¶¤ ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="reportBox" class="card" style="display:none;"><div id="reportText"></div><button class="btn-primary" style="background:#333;" onclick="copyReport()">ë¦¬í¬íŠ¸ ë³µì‚¬</button></div>
    </div>
</div>

<script>
let participants = {};
let allCheckins = {};
let firebaseDb; // db ì¤‘ë³µ ì„ ì–¸ ë°©ì§€ë¥¼ ìœ„í•´ í•˜ë‚˜ë§Œ ì‚¬ìš©

const todayObj = new Date();
todayObj.setHours(0,0,0,0);
let currentYear = todayObj.getFullYear();
let currentMonth = todayObj.getMonth() + 1;

function checkLogin() {
    if(document.getElementById('adminPw').value === "1230") {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('admin-main').style.display = 'block';
        init();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function changeTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

function init() {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    firebaseDb = firebase.database();
    
    document.getElementById('startDateInput').value = `${currentYear}-${String(currentMonth).padStart(2,'0')}-01`;

    // 1. ì°¸ê°€ì ë°ì´í„° ë¡œë“œ
    firebaseDb.ref("participants").on("value", snap => {
        participants = snap.val() || {};
        updateUserSelect();
        refresh();
    });

    // 2. ì²´í¬ì¸ ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„ ë°˜ì˜)
    firebaseDb.ref("checkins").on("value", snap => {
        allCheckins = snap.val() || {};
        refresh();
    });
}

function updateUserSelect() {
    const sel = document.getElementById('inputUser');
    if(!sel) return;
    sel.innerHTML = '<option value="">-- íšŒì› ì„ íƒ --</option>';
    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        sel.innerHTML += `<option value="${uid}">${uid}. ${p.name}</option>`;
    });
}

function refresh() {
    renderAttendance(); // ì¶œì„ë¶€ ê°±ì‹ 
    renderRanking();    // ğŸ† ëŒ€ì‹œë³´ë“œ ë­í‚¹ ê°±ì‹ 
}

// ğŸ† ëŒ€ì‹œë³´ë“œ ëˆ„ì  ì¶œì„ ë­í‚¹ ë Œë”ë§ í•¨ìˆ˜
function renderRanking() {
    const rankListEl = document.getElementById('rankList');
    if(!rankListEl) return;

    const lastDay = new Date(currentYear, currentMonth, 0).getDate();
    let scores = [];

    // ì°¸ê°€ìë³„ ì´ë²ˆ ë‹¬ ì¶œì„ íšŸìˆ˜ ê³„ì‚°
    Object.entries(participants).forEach(([uid, p]) => {
        let count = 0;
        for(let i=1; i<=lastDay; i++) {
            const dKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(allCheckins[dKey] && allCheckins[dKey][uid]) count++;
        }
        scores.push({ name: p.name, count: count, uid: uid });
    });

    // ì¶œì„ íšŸìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    scores.sort((a, b) => b.count - a.count);

    let html = "";
    scores.forEach((s, idx) => {
        html += `
            <div class="ranking-item">
                <span><b>${idx + 1}ìœ„</b> ${s.name} (${s.uid}ë²ˆ)</span>
                <b>${s.count}íšŒ ì„±ê³µ</b>
            </div>`;
    });
    rankListEl.innerHTML = html || "ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
}

function renderAttendance() {
    document.getElementById('monthLabel').innerText = `${currentYear}ë…„ ${currentMonth}ì›” í˜„í™©`;
    const lastDay = new Date(currentYear, currentMonth, 0).getDate();
    
    let head = '<tr><th>ì´ë¦„</th>';
    for(let i=1; i<=lastDay; i++) {
        const dateObj = new Date(currentYear, currentMonth-1, i);
        const cls = dateObj.getDay() === 0 ? 'class="sun-col"' : (dateObj > todayObj ? 'class="future-col"' : '');
        head += `<th ${cls}>${i}</th>`;
    }
    head += '</tr>';
    document.getElementById('atHead').innerHTML = head;

    let body = '';
    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        body += `<tr><td>${p.name}</td>`;
        for(let i=1; i<=lastDay; i++) {
            const dateObj = new Date(currentYear, currentMonth-1, i);
            const dKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const ok = allCheckins[dKey] && allCheckins[dKey][uid];
            if (dateObj.getDay() === 0) body += `<td class="sun-col">ì¼</td>`;
            else if (dateObj > todayObj) body += `<td class="future-col">-</td>`;
            else body += `<td>${p.status==='rest'?'íœ´':(ok?'O':'X')}</td>`;
        }
        body += '</tr>';
    });
    document.getElementById('atBody').innerHTML = body;
}

async function doManual(isPresent) {
    const date = document.getElementById('inputDate').value;
    const uid = document.getElementById('inputUser').value;
    if(!date || !uid) return alert("ë‚ ì§œì™€ íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");
    const path = `checkins/${date}/${uid}`;
    isPresent ? await firebaseDb.ref(path).set({ name: participants[uid].name, timestamp: Date.now() }) : await firebaseDb.ref(path).remove();
    alert("ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function makeReport() {
    const fee = document.getElementById('feeInput').value;
    const startDateVal = document.getElementById('startDateInput').value;
    const startDate = new Date(startDateVal);
    startDate.setHours(0,0,0,0);

    let total = 0;
    let html = `<h3>[ì •ì‚° ë¦¬í¬íŠ¸]</h3><p style="font-size:11px;">ê¸°ì¤€: ${startDateVal} ~ ì˜¤ëŠ˜</p><br>`;

    Object.entries(participants).sort((a,b)=>a[0]-b[0]).forEach(([uid, p]) => {
        if(p.status === 'rest') return;
        let absentCount = 0;
        for(let i=1; i<=new Date(currentYear, currentMonth, 0).getDate(); i++) {
            const checkDate = new Date(currentYear, currentMonth-1, i);
            checkDate.setHours(0,0,0,0);
            if(checkDate < startDate || checkDate.getDay() === 0 || checkDate > todayObj) continue;
            const dStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            if(!(allCheckins[dStr] && allCheckins[dStr][uid])) absentCount++;
        }
        const penalty = absentCount * fee;
        total += penalty;
        if(penalty > 0) html += `<div class="ranking-item" style="border-left-color:red;"><span>${p.name} (${absentCount}íšŒ)</span><b>${penalty.toLocaleString()}ì›</b></div>`;
    });
    html += `<br><div style="text-align:right; font-weight:bold; color:red; font-size:18px;">ì´í•©: ${total.toLocaleString()}ì›</div>`;
    document.getElementById('reportText').innerHTML = html;
    document.getElementById('reportBox').style.display = 'block';
}

function copyReport() {
    const txt = document.getElementById('reportText').innerText;
    navigator.clipboard.writeText(txt).then(() => alert("ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
}
</script>
</body>
</html>
