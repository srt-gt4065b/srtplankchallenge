<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRTí”Œë­í¬ì±Œë¦°ì§€ í”Œë«í¼</title>
    <!-- Bootstrap CSS for UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Noto Sans KR', sans-serif; }
        .container { max-width: 600px; margin-top: 30px; }
        .hidden { display: none !important; }
        .day-btn { width: 45px; height: 45px; margin: 3px; font-size: 12px; }
        .card { margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .member-list { max-height: 150px; overflow-y: auto; font-size: 0.9em; }
        #landing-page { text-align: center; margin-top: 100px; }
        .active-day { border: 2px solid #0d6efd; font-weight: bold; }
        .completed-day { background-color: #198754; color: white; }
    </style>
    
    <!-- Firebase SDK (Compat version for easier usage in single HTML) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div class="container">
        
        <!-- 1. Landing Page -->
        <div id="landing-page">
            <h1 class="mb-5 fw-bold text-primary">SRTí”Œë­í¬ì±Œë¦°ì§€<br>í”Œë«í¼</h1>
            <button class="btn btn-primary btn-lg w-50 rounded-pill" onclick="goToSecret()">ë“¤ì–´ê°€ê¸°</button>
        </div>

        <!-- 2. Secret Question Page -->
        <div id="secret-page" class="hidden card p-4">
            <h3 class="text-center mb-4">ğŸ” ë³´ì•ˆ í™•ì¸</h3>
            <div class="mb-3">
                <label class="form-label">SRT 8ê¸° íšŒì¥ë‹˜ ì´ë¦„ì€?</label>
                <input type="text" id="secret-answer" class="form-control" placeholder="ì„œì¸ìˆ˜">
            </div>
            <button class="btn btn-dark w-100" onclick="checkSecret()">í™•ì¸</button>
            <div id="secret-error" class="text-danger mt-2 text-center hidden">ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- 3. User Info / Register Page -->
        <div id="register-page" class="hidden card p-4">
            <h3 class="text-center mb-4">ğŸ“ ì°¸ê°€ì ë“±ë¡</h3>
            <div class="mb-3">
                <label class="form-label">ì¹´í˜ ë‹‰ë„¤ì„</label>
                <input type="text" id="reg-nickname" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">ì´ë¦„ (ì‹¤ëª…)</label>
                <input type="text" id="reg-name" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">ì „í™”ë²ˆí˜¸ (ë’¤ 4ìë¦¬)</label>
                <input type="number" id="reg-phone" class="form-control" placeholder="ì˜ˆ: 1234">
            </div>
            <button class="btn btn-success w-100" onclick="registerUser()">ì…ì¥ ë° ë“±ë¡</button>
        </div>

        <!-- 4. Dashboard Page -->
        <div id="dashboard-page" class="hidden">
            <!-- Member List Section -->
            <div class="card p-3">
                <h5 class="fw-bold">ğŸ‘¥ í˜„ì¬ ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ (<span id="member-count">0</span>ëª…)</h5>
                <ul id="member-list-ul" class="list-group member-list">
                    <!-- Members will be loaded here -->
                    <li class="list-group-item text-center text-muted">ë¡œë”©ì¤‘...</li>
                </ul>
            </div>

            <!-- Calendar Section -->
            <div class="card p-3 text-center">
                <h5 class="fw-bold mb-3">ğŸ“… 12ì›” ì±Œë¦°ì§€ í˜„í™©</h5>
                <div id="calendar-grid" class="d-flex flex-wrap justify-content-center">
                    <!-- Buttons generated by JS -->
                </div>
            </div>

            <!-- Daily Mission Input Section -->
            <div id="mission-area" class="card p-3 hidden">
                <h5 class="fw-bold text-primary">ğŸ’ª <span id="selected-date-display"></span> ë¯¸ì…˜ ì¸ì¦</h5>
                <div class="mb-3">
                    <textarea id="mission-content" class="form-control" rows="3" placeholder="ìˆ˜í–‰ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 3ë¶„ í”Œë­í¬ ì™„ë£Œ!)"></textarea>
                </div>
                <button class="btn btn-primary w-100" onclick="submitMission()">ì¸ì¦ ì œì¶œí•˜ê¸°</button>
            </div>
            
            <!-- Today's Logs Display -->
            <div class="card p-3 mt-3">
                <h6 class="fw-bold">ğŸ“¢ ì˜¤ëŠ˜ì˜ ì¸ì¦ í˜„í™©</h6>
                <div id="today-logs-list"></div>
            </div>
        </div>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // ============================================================
        // [ì„¤ì •] 1. íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • (ë³¸ì¸ì˜ ì„¤ì •ìœ¼ë¡œ êµì²´ í•„ìˆ˜!)
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAreNnVP9P92JB3fxgqkJY4fm0FWwN-cIo",
  authDomain: "srtchallenge.firebaseapp.com",
  databaseURL: "https://srtchallenge-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "srtchallenge",
  storageBucket: "srtchallenge.firebasestorage.app",
  messagingSenderId: "419930370414",
  appId: "1:419930370414:web:dd4fe1f48cd7003cc7917f"
        };

        // Firebase ì´ˆê¸°í™”
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ì„¤ì •ê°’ì„ í™•ì¸í•˜ì„¸ìš”.", e);
            alert("DB ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì½”ë“œ ë‚´ë¶€ì˜ firebaseConfigë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.");
        }
        const db = firebase.firestore();

        // ============================================================
        // [ì„¤ì •] 2. ì•± ì„¤ì • ë³€ìˆ˜
        // ============================================================
        const CORRECT_SECRET_ANSWER = "í™ê¸¸ë™"; // ì •ë‹µ: ì‹¤ì œ íšŒì¥ë‹˜ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
        const TARGET_MONTH = 11; // 0~11 (11ì€ 12ì›”)
        let currentUser = null;

        // ============================================================
        // [ë¡œì§] í™”ë©´ ì „í™˜ í•¨ìˆ˜
        // ============================================================
        function showSection(id) {
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function goToSecret() {
            // ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ìì¸ì§€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í™•ì¸ (ê°„ì´ ë¡œê·¸ì¸ ìœ ì§€)
            const savedUser = localStorage.getItem('srt_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                goToDashboard();
            } else {
                showSection('secret-page');
            }
        }

        // ============================================================
        // [ë¡œì§] ì‹œí¬ë¦¿ ì§ˆë¬¸ í™•ì¸
        // ============================================================
        function checkSecret() {
            const input = document.getElementById('secret-answer').value.trim();
            if (input === CORRECT_SECRET_ANSWER) {
                showSection('register-page');
            } else {
                document.getElementById('secret-error').classList.remove('hidden');
            }
        }

        // ============================================================
        // [ë¡œì§] íšŒì›ê°€ì… ë° ë¡œê·¸ì¸
        // ============================================================
        async function registerUser() {
            const nickname = document.getElementById('reg-nickname').value.trim();
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();

            if (!nickname || !name || !phone) {
                alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const userData = { nickname, name, phone, joinedAt: new Date() };
            
            try {
                // Firestore 'users' ì»¬ë ‰ì…˜ì— ì „í™”ë²ˆí˜¸ë¥¼ IDë¡œ ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
                await db.collection('users').doc(phone).set(userData, { merge: true });
                
                currentUser = userData;
                localStorage.setItem('srt_user', JSON.stringify(userData)); // ë¡œì»¬ ì €ì¥
                alert("í™˜ì˜í•©ë‹ˆë‹¤! ì±Œë¦°ì§€ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                goToDashboard();
            } catch (error) {
                console.error("Error adding user: ", error);
                alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ============================================================
        // [ë¡œì§] ëŒ€ì‹œë³´ë“œ ì§„ì… ë° ë°ì´í„° ë¡œë“œ
        // ============================================================
        function goToDashboard() {
            showSection('dashboard-page');
            loadMembers();
            renderCalendar();
            loadTodayLogs();
        }

        // íšŒì› ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„)
        function loadMembers() {
            db.collection('users').onSnapshot((snapshot) => {
                const listEl = document.getElementById('member-list-ul');
                const countEl = document.getElementById('member-count');
                listEl.innerHTML = "";
                
                let count = 0;
                snapshot.forEach((doc) => {
                    const u = doc.data();
                    const li = document.createElement('li');
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.innerHTML = `
                        <span>${u.nickname} (${u.name})</span>
                        <span class="badge bg-secondary rounded-pill">${u.phone}</span>
                    `;
                    listEl.appendChild(li);
                    count++;
                });
                countEl.innerText = count;
            });
        }

        // ============================================================
        // [ë¡œì§] ìº˜ë¦°ë” ë° ì¸ì¦ ë²„íŠ¼ ìƒì„±
        // ============================================================
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = "";
            
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-based
            const currentDate = today.getDate();

            // 12ì›”ì€ 31ì¼ê¹Œì§€ ìˆìŒ
            for (let i = 1; i <= 31; i++) {
                const btn = document.createElement('button');
                btn.className = "btn btn-outline-secondary day-btn";
                btn.innerText = i;
                btn.id = `day-btn-${i}`;

                // í˜„ì¬ ë‹¬ì´ 12ì›”ì´ê³ , í•´ë‹¹ ë‚ ì§œê°€ ì˜¤ëŠ˜ì´ë©´ í™œì„±í™”
                if (currentMonth === TARGET_MONTH && i === currentDate) {
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-primary', 'active-day');
                    btn.onclick = () => openMissionForm(i);
                } else {
                    // ì˜¤ëŠ˜ì´ ì•„ë‹ˆë©´ ë¹„í™œì„±í™” (ì§€ë‚œ ë‚ ì§œëŠ” ì¡°íšŒ ê¸°ëŠ¥ ë“±ì„ ë„£ì„ ìˆ˜ ìˆìœ¼ë‚˜ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ë¹„í™œì„±)
                    btn.disabled = true;
                }
                
                grid.appendChild(btn);
            }
        }

        // ë¯¸ì…˜ ì…ë ¥ í¼ ì—´ê¸°
        function openMissionForm(day) {
            document.getElementById('mission-area').classList.remove('hidden');
            document.getElementById('selected-date-display').innerText = `12ì›” ${day}ì¼`;
            // ê¸°ì¡´ ì‘ì„± ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ ì¶”ê°€ ë¡œì§ í•„ìš” (ì—¬ê¸°ì„  ìƒëµ)
        }

        // ============================================================
        // [ë¡œì§] ë¯¸ì…˜ ì œì¶œ
        // ============================================================
        async function submitMission() {
            const content = document.getElementById('mission-content').value.trim();
            if (!content) {
                alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const today = new Date();
            const dateStr = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`; // YYYY-M-D í˜•ì‹

            const missionData = {
                uid: currentUser.phone, // ì „í™”ë²ˆí˜¸ë¥¼ ì‹ë³„ìë¡œ ì‚¬ìš©
                nickname: currentUser.nickname,
                name: currentUser.name,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // 'missions' ì»¬ë ‰ì…˜ -> ë‚ ì§œ ë¬¸ì„œ -> 'logs' í•˜ìœ„ ì»¬ë ‰ì…˜ì— ì €ì¥
                await db.collection('missions').doc(dateStr).collection('logs').doc(currentUser.phone).set(missionData);
                
                alert("ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                document.getElementById('mission-content').value = ""; // ì´ˆê¸°í™”
                document.getElementById('mission-area').classList.add('hidden'); // ë‹«ê¸°
            } catch (error) {
                console.error("Error submitting mission: ", error);
                alert("ì €ì¥ ì‹¤íŒ¨");
            }
        }

        // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì¸ì¦ ë¡œê·¸ ì‹¤ì‹œê°„ ì¡°íšŒ
        function loadTodayLogs() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
            const container = document.getElementById('today-logs-list');

            db.collection('missions').doc(dateStr).collection('logs')
                .orderBy('timestamp', 'desc')
                .onSnapshot((snapshot) => {
                    container.innerHTML = "";
                    if (snapshot.empty) {
                        container.innerHTML = "<p class='text-muted text-center small'>ì•„ì§ ì¸ì¦ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const log = doc.data();
                        const div = document.createElement('div');
                        div.className = "alert alert-light border p-2 mb-2";
                        div.innerHTML = `
                            <strong>${log.nickname}</strong> <span class="text-muted small">(${log.name})</span><br>
                            ${log.content}
                        `;
                        container.appendChild(div);
                    });
                });
        }

    </script>
</body>
</html>
